# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å Telegram –±–æ—Ç–æ–º

## –û–±–∑–æ—Ä

–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ —Å Telegram –±–æ—Ç–æ–º. –î–ª—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

1. **–ü–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞**
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∏–≥—Ä—ã**
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã**

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã URL

–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–∂–∏–¥–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL:

- `game_id` - ID –∏–≥—Ä—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `games`
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `users`

### –ü—Ä–∏–º–µ—Ä URL:

```
http://your-server-ip/?game_id=123&user_id=456
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ Telegram –±–æ—Ç–µ

### 1. –û—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã

–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –≤—ã–±–∏—Ä–∞–µ—Ç "—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å –±–æ—Ç–∞–º–∏" –∏–ª–∏ "–∏–≥—Ä–∞ —Å –¥—Ä—É–∑—å—è–º–∏", –±–æ—Ç –¥–æ–ª–∂–µ–Ω:

1. –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É –≤ –ë–î (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞)
2. –ü–æ–ª—É—á–∏—Ç—å `game_id` –∏ `user_id` (telegram_id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
3. –û—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å —ç—Ç–∏–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏

**–ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ –¥–ª—è –±–æ—Ç–∞:**

```python
from telegram import InlineKeyboardButton, InlineKeyboardMarkup

# –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
game = create_game(...)  # –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É –≤ –ë–î
user = get_user_by_telegram_id(telegram_id)

# URL –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
web_url = f"http://your-server-ip/?game_id={game.id}&user_id={user.id}"

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
keyboard = [
    [InlineKeyboardButton("üéÆ –û—Ç–∫—Ä—ã—Ç—å –∏–≥—Ä—É", url=web_url)],
    [InlineKeyboardButton("üö™ –ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É", callback_data=f"leave_game_{game.id}")]
]
reply_markup = InlineKeyboardMarkup(keyboard)

await context.bot.send_message(
    chat_id=update.effective_chat.id,
    text="–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.",
    reply_markup=reply_markup
)
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –∏–≥—Ä—ã

–ö–æ–≥–¥–∞ –∏–≥—Ä–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç "–ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É" –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ:

1. Frontend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –∑–∞–ø—Ä–æ—Å –Ω–∞ `/api/game/leave` —Å `game_id` –∏ `user_id`
2. API –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–∞ –≤ –ë–î (`left_game = True`)
3. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–æ–≤ –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Redis

**–ü—Ä–∏–º–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ –±–æ—Ç–µ:**

```python
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä–æ–∫–∞
def check_player_left_game(session, game_id, user_id):
    game_player = session.query(GamePlayer).filter(
        and_(
            GamePlayer.game_id == game_id,
            GamePlayer.user_id == user_id,
            GamePlayer.left_game == True
        )
    ).first()
    return game_player is not None

# –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ callback –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ
if check_player_left_game(session, game_id, user_id):
    # –í–µ—Ä–Ω—É—Ç—å –∏–≥—Ä–æ–∫–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
    await show_main_menu(update, context)
```

### 3. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã

–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞ –∏–≥—Ä—ã
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç–≤–µ—Ç—ã –∏–≥—Ä–æ–∫–æ–≤ –≤ –ë–î

–ë–æ—Ç –º–æ–∂–µ—Ç:
- –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–≥—Ä—ã —á–µ—Ä–µ–∑ –ë–î
- –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –ø—Ä–∏ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
- –£–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—É–Ω–¥–∞–º–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –º–µ–∂–¥—É –Ω–∏–º–∏

## API Endpoints

### GET `/api/questions/random?game_id=X&user_id=Y`

–ü–æ–ª—É—á–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞ –∏–≥—Ä—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `game_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - ID –∏–≥—Ä—ã
- `user_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–û—Ç–≤–µ—Ç:**
```json
{
  "question": {
    "id": 123,
    "text": "–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞",
    "answers": [...],
    "time_limit": 10
  }
}
```

### GET `/api/leaderboard?game_id=X&user_id=Y`

–ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –ª–∏–¥–µ—Ä–æ–≤ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `game_id` (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) - ID –∏–≥—Ä—ã
- `user_id` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –ø–æ–º–µ—Ç–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞)

**–û—Ç–≤–µ—Ç:**
```json
{
  "participants": [
    {
      "id": 1,
      "name": "–ò–≥—Ä–æ–∫ 1",
      "correct_answers": 5,
      "is_current_user": true
    }
  ],
  "current_question_number": 3,
  "total_questions": 10
}
```

### POST `/api/answer`

–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "question_id": 123,
  "answer_id": 1,
  "is_correct": true,
  "game_id": 456,
  "user_id": 789,
  "round_question_id": 101,
  "selected_option": "A",
  "answer_time": 5.5
}
```

### POST `/api/game/leave`

–ü–æ–∫–∏–Ω—É—Ç—å –∏–≥—Ä—É.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "game_id": 456,
  "user_id": 789
}
```

## Fallback –Ω–∞ –º–æ–∫-–¥–∞–Ω–Ω—ã–µ

–ï—Å–ª–∏ `game_id` –∏–ª–∏ `user_id` –Ω–µ —É–∫–∞–∑–∞–Ω—ã –≤ URL, –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–∫-–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è. –≠—Ç–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, –Ω–æ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å—Å—è —ç—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

1. **–û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:**
   ```
   http://your-server-ip/?game_id=1&user_id=1
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12):**
   - –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `üéÆ App initialized: game_id=1, user_id=1`
   - –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç: `‚ö†Ô∏è game_id or user_id missing from URL`

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ API:**
   ```bash
   sudo docker compose logs api --tail=50
   ```
   - –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å—ã —Å `game_id` –∏ `user_id`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ –±–æ—Ç:**
   - –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏–≥—Ä—ã
   - –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—ã—Ö–æ–¥ –∏–∑ –∏–≥—Ä—ã
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–æ—Ç–æ–º –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º

2. **–£–ª—É—á—à–∏—Ç—å UX:**
   - –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ (–∏–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω)
   - –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–∏–∫–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
   - –£–ª—É—á—à–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
   - WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
   - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
